// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["fullTextSearch"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id            Int          @id @default(autoincrement())
  email         String?      @unique
  password      String
  name          String
  phone         String       @unique
  role          String       @default("CUSTOMER") // "SUPER_ADMIN", "STAFF", "CUSTOMER"
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  orders        Order[]      @relation("CustomerOrders")
  handledOrders Order[]      @relation("HandledOrders")
  reviews       Review[]
  wishlist      Wishlist[]
  stockAlerts   StockAlert[]

  // Auth & Security
  resetPasswordToken     String?
  resetPasswordExpires   DateTime?
  isEmailVerified        Boolean   @default(false)
  emailVerificationToken String?

  twoFactorEnabled     Boolean   @default(false)
  twoFactorCode        String?
  twoFactorCodeExpires DateTime?

  cart          Cart?
  loyaltyPoints LoyaltyPoints?
}

model AuditLog {
  id         Int      @id @default(autoincrement())
  userId     Int
  action     String // "product.create", "order.status_update", "user.role_change", "stock.bulk_update"
  entityType String // "Product", "Order", "User", "Settings"
  entityId   Int?
  details    String? // JSON
  ipAddress  String?
  createdAt  DateTime @default(now())
}

model Cart {
  id           Int              @id @default(autoincrement())
  userId       Int              @unique
  user         User             @relation(fields: [userId], references: [id])
  items        CartItem[]
  variantItems CartItemVariant[]
  updatedAt    DateTime         @updatedAt
}

model CartItem {
  id        Int     @id @default(autoincrement())
  cartId    Int
  cart      Cart    @relation(fields: [cartId], references: [id])
  productId Int
  product   Product @relation(fields: [productId], references: [id])
  quantity  Int

  @@unique([cartId, productId])
}

// ═══ CATEGORY — Alt Kategori Desteği ═══
model Category {
  id        Int        @id @default(autoincrement())
  name      String
  image     String?
  parentId  Int?
  parent    Category?  @relation("CategoryTree", fields: [parentId], references: [id])
  children  Category[] @relation("CategoryTree")
  products  Product[]
  sortOrder Int        @default(0)
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  @@unique([name, parentId])
}

model Product {
  id          Int      @id @default(autoincrement())
  name        String
  description String
  price       Decimal
  image       String?
  categoryId  Int
  // Relations
  category    Category @relation(fields: [categoryId], references: [id])

  // Relations
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  orderItems        OrderItem[]
  reviews           Review[]
  wishlist          Wishlist[]
  stock             Int              @default(0)
  stockAlerts       StockAlert[]
  isFeatured        Boolean          @default(false)
  cartItems         CartItem[]
  images            ProductImage[]
  isDeleted         Boolean          @default(false)
  rating            Float            @default(0)
  numReviews        Int              @default(0)
  sku               String?          @unique
  barcode           String?          @unique
  lowStockThreshold Int              @default(5)
  stockMovements    StockMovement[]

  // ═══ YENİ ALANLAR ═══
  brandId        Int?
  brand          Brand?           @relation(fields: [brandId], references: [id])
  compareAtPrice Decimal?         // Eski fiyat (üstü çizili gösterilecek)
  variants       ProductVariant[]
}

model ProductImage {
  id        Int     @id @default(autoincrement())
  url       String
  productId Int
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  isMain    Boolean @default(false)
}

model StockMovement {
  id            Int      @id @default(autoincrement())
  productId     Int
  product       Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  type          String // "IN", "OUT", "ADJUSTMENT", "ORDER"
  quantity      Int
  previousStock Int
  newStock      Int
  reason        String?
  createdBy     Int?
  createdAt     DateTime @default(now())
}

model Order {
  id          Int     @id @default(autoincrement())
  userId      Int?
  user        User?   @relation("CustomerOrders", fields: [userId], references: [id])
  // Customer Info for this specific order
  fullName    String?
  phoneNumber String?
  email       String?
  note        String?

  // Click & Collect
  pickupRequestedTime String?
  pickupCode          String?   @unique
  pickupCodeExpiresAt DateTime?

  // Status & Lifecycle
  status        String    @default("PENDING") // PENDING, PREPARING, READY, COMPLETED, CANCELLED
  statusHistory String    @default("[]") // JSON string of status updates
  readyAt       DateTime?
  completedAt   DateTime?

  // Staff handling
  handledByUserId Int?
  handledBy       User? @relation("HandledOrders", fields: [handledByUserId], references: [id])

  // Financials
  totalAmount      Decimal
  couponCode       String?
  discountAmount   Decimal @default(0)
  campaignDiscount Decimal @default(0)
  campaignDetails  String? // JSON array of applied campaigns

  items     OrderItem[]
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  // ═══ YENİ ALANLAR ═══
  branchId     Int?
  branch       Branch?          @relation(fields: [branchId], references: [id])
  variantItems OrderItemVariant[]
}

model OrderItem {
  id        Int     @id @default(autoincrement())
  orderId   Int
  order     Order   @relation(fields: [orderId], references: [id])
  productId Int
  product   Product @relation(fields: [productId], references: [id])
  quantity  Int
  price     Decimal
}

model Review {
  id        Int      @id @default(autoincrement())
  rating    Int
  comment   String?
  userId    Int
  user      User     @relation(fields: [userId], references: [id])
  productId Int
  product   Product  @relation(fields: [productId], references: [id])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Wishlist {
  id        Int      @id @default(autoincrement())
  userId    Int
  user      User     @relation(fields: [userId], references: [id])
  productId Int
  product   Product  @relation(fields: [productId], references: [id])
  createdAt DateTime @default(now())

  @@unique([userId, productId])
}

model Coupon {
  id             Int       @id @default(autoincrement())
  code           String    @unique
  discountType   String // "PERCENTAGE" or "FIXED"
  discountValue  Decimal
  minOrderAmount Decimal   @default(0)
  expirationDate DateTime?
  isActive       Boolean   @default(true)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
}

model StockAlert {
  id        Int      @id @default(autoincrement())
  userId    Int
  user      User     @relation(fields: [userId], references: [id])
  productId Int
  product   Product  @relation(fields: [productId], references: [id])
  isNotified Boolean @default(false)
  createdAt DateTime @default(now())

  @@unique([userId, productId])
}

model HeroSlide {
  id          Int      @id @default(autoincrement())
  title       String
  subtitle    String?
  description String?
  imageUrl    String
  link        String?
  order       Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model SystemSetting {
  key         String   @id
  value       String
  description String?
  type        String   @default("text") // text, longtext, image, boolean, color
  group       String   @default("general") // general, contact, social, appearance
  updatedAt   DateTime @updatedAt
}

model Campaign {
  id        Int      @id @default(autoincrement())
  name      String
  type      String // "BUY_X_GET_Y", "CATEGORY_DISCOUNT", "FLASH_SALE", "LOYALTY"
  config    String // JSON config
  startDate DateTime
  endDate   DateTime
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model LoyaltyPoints {
  id      Int              @id @default(autoincrement())
  userId  Int              @unique
  user    User             @relation(fields: [userId], references: [id])
  points  Int              @default(0)
  history LoyaltyHistory[]
}

model LoyaltyHistory {
  id        Int           @id @default(autoincrement())
  loyaltyId Int
  loyalty   LoyaltyPoints @relation(fields: [loyaltyId], references: [id])
  points    Int // Positive = earn, Negative = spend
  reason    String // "Order #123", "Point usage", "Referral bonus"
  createdAt DateTime      @default(now())
}

model SearchLog {
  id          Int      @id @default(autoincrement())
  query       String
  resultCount Int      @default(0)
  createdAt   DateTime @default(now())

  @@index([query])
  @@index([createdAt])
}

// ═══ ŞUBE SİSTEMİ ═══
model Branch {
  id           Int      @id @default(autoincrement())
  name         String   @unique // "Uydukent Şubesi", "Fatih Şubesi"
  address      String
  phone        String?
  district     String?  // "Selçuklu Mah.", "Fatih Mah."
  city         String   @default("Afyonkarahisar")
  latitude     Float?
  longitude    Float?
  workingHours String?  // JSON: {"mon":"09:00-18:00", ...}
  isActive     Boolean  @default(true)
  orders       Order[]
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

// ═══ MARKA SİSTEMİ ═══
model Brand {
  id        Int       @id @default(autoincrement())
  name      String    @unique
  logo      String?
  isActive  Boolean   @default(true)
  products  Product[]
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

// ═══ DİNAMİK VARYANT SİSTEMİ ═══

// Özellik tipleri: "Renk", "Boyut", "Gramaj", "Uç Kalınlığı", vb.
model AttributeType {
  id        Int              @id @default(autoincrement())
  name      String           @unique // "Renk", "Boyut", "Kalem Ucu"
  sortOrder Int              @default(0)
  values    AttributeValue[]
  createdAt DateTime         @default(now())
}

// Özellik değerleri: "Kırmızı", "A4", "0.7mm", vb.
model AttributeValue {
  id              Int                @id @default(autoincrement())
  attributeTypeId Int
  attributeType   AttributeType      @relation(fields: [attributeTypeId], references: [id], onDelete: Cascade)
  value           String             // "Kırmızı", "A4", "0.7mm"
  colorHex        String?            // Renk tipi için: "#FF0000"
  sortOrder       Int                @default(0)
  variantValues   VariantAttribute[]

  @@unique([attributeTypeId, value])
}

// Ürün varyantları: Belirli bir ürünün belirli özellik kombinasyonu
model ProductVariant {
  id         Int                @id @default(autoincrement())
  productId  Int
  product    Product            @relation(fields: [productId], references: [id], onDelete: Cascade)
  sku        String?            @unique
  barcode    String?            @unique
  price      Decimal?           // null ise ana ürün fiyatı kullanılır
  stock      Int                @default(0)
  image      String?            // Varyanta özel görsel
  isActive   Boolean            @default(true)
  attributes VariantAttribute[]
  cartItems  CartItemVariant[]
  orderItems OrderItemVariant[]
  createdAt  DateTime           @default(now())
  updatedAt  DateTime           @updatedAt
}

// Varyant-Özellik ilişkisi (many-to-many)
model VariantAttribute {
  id               Int            @id @default(autoincrement())
  variantId        Int
  variant          ProductVariant @relation(fields: [variantId], references: [id], onDelete: Cascade)
  attributeValueId Int
  attributeValue   AttributeValue @relation(fields: [attributeValueId], references: [id])

  @@unique([variantId, attributeValueId])
}

// Sepetteki varyant bilgisi
model CartItemVariant {
  id         Int            @id @default(autoincrement())
  variantId  Int
  variant    ProductVariant @relation(fields: [variantId], references: [id])
  quantity   Int
  cartId     Int
  cart       Cart           @relation(fields: [cartId], references: [id])

  @@unique([cartId, variantId])
}

// Siparişteki varyant bilgisi
model OrderItemVariant {
  id          Int            @id @default(autoincrement())
  variantId   Int
  variant     ProductVariant @relation(fields: [variantId], references: [id])
  quantity    Int
  price       Decimal
  orderId     Int
  order       Order          @relation(fields: [orderId], references: [id])
  // Sipariş anındaki özellik snapshot'ı
  attributes  String?        // JSON: [{"type":"Renk","value":"Kırmızı"},{"type":"Boyut","value":"A4"}]
}

// ═══ HEDİYE ÇARKI SİSTEMİ ═══

// Çark tanımı
model SpinWheel {
  id             Int         @id @default(autoincrement())
  name           String      // "3000 TL Çarkı", "Yılbaşı Özel Çarkı"
  minOrderAmount Decimal     // Minimum sipariş tutarı (0 = mağaza içi manuel)
  isActive       Boolean     @default(true)
  isManualOnly   Boolean     @default(false) // true = sadece admin kod üretebilir
  validFrom      DateTime?
  validUntil     DateTime?
  prizes         SpinPrize[]
  codes          SpinCode[]
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt
}

// Çarktaki ödüller ve olasılıkları
model SpinPrize {
  id          Int        @id @default(autoincrement())
  wheelId     Int
  wheel       SpinWheel  @relation(fields: [wheelId], references: [id], onDelete: Cascade)
  name        String     // "50 TL İndirim Kuponu", "Silgi Seti", "Boş"
  type        String     // "COUPON", "PRODUCT", "POINTS", "EMPTY"
  value       String?    // Kupon kodu prefix, ürün ID, puan miktarı
  probability Float      // 0.0 - 1.0 (toplam 1.0 olmalı)
  color       String?    // Çark dilim rengi
  icon        String?    // Emoji veya ikon ismi
  maxWins     Int?       // Maksimum kazanma sayısı (null = sınırsız)
  winCount    Int        @default(0) // Şu ana kadar kazanılma sayısı
  isActive    Boolean    @default(true)
  codes       SpinCode[]
  sortOrder   Int        @default(0)
}

// Çevirme kodları
model SpinCode {
  id           Int        @id @default(autoincrement())
  code         String     @unique // "SPIN-A8F3K2"
  wheelId      Int
  wheel        SpinWheel  @relation(fields: [wheelId], references: [id])
  orderId      Int?       // Online sipariş ile oluşturulduysa
  userId       Int?       // Kullanan kullanıcı
  isUsed       Boolean    @default(false)
  usedAt       DateTime?
  prizeId      Int?       // Kazanılan ödül
  prize        SpinPrize? @relation(fields: [prizeId], references: [id])
  prizeResult  String?    // JSON: Kazanılan ödülün detayı
  // Manuel oluşturma bilgisi
  createdById  Int?       // Admin ID (manuel oluşturulduysa)
  customerNote String?    // "3200TL alışveriş - Ahmet Bey"
  expiresAt    DateTime?
  createdAt    DateTime   @default(now())
}
